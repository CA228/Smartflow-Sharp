<?xml version="1.0" encoding="utf-8" ?>
<hibernate-mapping xmlns="urn:nhibernate-mapping-2.2"
                   assembly="Smartflow.Bussiness"
                   namespace="Smartflow.Bussiness.Models">

	<class name="Category" table="t_wf_category">
		<id name="Code" column="Code" type="String" generator="assigned"/>
		<property name="Name" column="Name" type="String" />
		<property name="Url" column="Url" type="String" />
		<property name="ParentCode" column="ParentCode" type="String" />
	</class>

	<class name="StatisticsInstance">
		<id name="Code" column="Code" type="String" generator="assigned"/>
		<property name="Name"  type="String" />
		<property name="Url" type="String" />
		<property name="ParentCode" type="String" />
		<property name="Total" type="Int32" />
	</class>

	<sql-query name="queryStatisticsInstanceByUserId">
		<return alias="tx" class="Smartflow.Bussiness.Models.StatisticsInstance"/>
		select {tx.*} from (select c.*,Total from [dbo].[t_wf_category] c, (select CategoryCode, Count(1) Total from [dbo].[t_wf_instance] where id in (select instanceId from t_wf_task where status=0) group by CategoryCode) as i where c.Code = i.CategoryCode  AND I.CategoryCode in (select i.CategoryCode from t_wf_task x, t_wf_task_auth y,t_wf_instance i where x.Status = 0 and x.id = y.TaskId and i.id = X.InstanceId and ((y.Type = 1 and y.AuthCode =:userId) or(y.Type = 0 and y.AuthCode in (select RID from [dbo].[t_sys_umr] where UID =:userId)) or(y.Type = 2 and y.AuthCode in (select OrganizationCode from [dbo].[t_sys_user] where ID =:userId))))) as tx
	</sql-query>
</hibernate-mapping>
